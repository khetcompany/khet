<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>📄 CMS Quill Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; max-width: 900px; margin: auto; background: #f9f9f9; }
    input, button { padding: 10px; margin: 10px 0; font-size: 1rem; width: 100%; }
    #editor-container { height: 300px; background: #fff; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h2>📝 Soạn & Đăng bài với Quill</h2>
  <input type="text" id="title" placeholder="Tiêu đề bài viết">
  <input type="text" id="filename" placeholder="Tên file (vd: bai-viet-1.html)">
  <div id="toolbar-container">
    <span class="ql-formats">
      <button class="ql-bold"></button>
      <button class="ql-italic"></button>
      <button class="ql-underline"></button>
      <button class="ql-image"></button>
    </span>
  </div>
  <div id="editor-container"></div>
  <input type="file" id="imageInput" accept="image/*" style="display:none">
  <button onclick="uploadPost()">🚀 Đăng bài</button>
  <p id="status"></p>

  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <script>
    const quill = new Quill('#editor-container', {
      theme: 'snow',
      modules: {
        toolbar: {
          container: '#toolbar-container',
          handlers: {
            image: () => document.getElementById('imageInput').click()
          }
        }
      }
    });

    document.getElementById('imageInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const base64 = await toBase64(file);
      const path = `media/img-post/${file.name}`;
      try {
        await uploadToGitHub(path, base64);
        const range = quill.getSelection();
        const url = `https://raw.githubusercontent.com/khetcompany/khet/main/${path}`;
        quill.insertEmbed(range.index, 'image', url);
      } catch (err) {
        alert('❌ Lỗi upload ảnh: ' + err.message);
      }
    });

    async function uploadPost() {
      const title = document.getElementById('title').value.trim();
      const filename = document.getElementById('filename').value.trim();
      const content = quill.root.innerHTML;
      if (!title || !filename || !content) return alert('❗ Điền đầy đủ thông tin');

      const html = `<!DOCTYPE html><html><head><meta charset='UTF-8'><title>${title}</title></head><body><h1>${title}</h1>${content}</body></html>`;
      const htmlBase64 = btoa(unescape(encodeURIComponent(html)));
      try {
        await uploadToGitHub(`post/${filename}`, htmlBase64);
        document.getElementById('status').innerText = '✅ Đăng bài thành công!';
      } catch (err) {
        document.getElementById('status').innerText = '❌ Lỗi: ' + err.message;
      }
    }

    async function uploadToGitHub(path, contentBase64) {
      const token = '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';
      const res = await fetch(`https://api.github.com/repos/khetcompany/khet/contents/${path}`, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Upload ${path}`,
          content: contentBase64
        })
      });

      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.message);
      }
    }

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>
