<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>CMS Đăng bài từ file ZIP</title>
  <style>
    body { font-family: Arial; padding: 2rem; max-width: 600px; margin: auto; }
    input, button { width: 100%; padding: 10px; margin: 10px 0; }
  </style>
</head>
<body>
  <h2>Đăng bài từ file .zip</h2>
  <input type="text" id="filename" placeholder="Tên file HTML sau khi upload (vd: bai-viet-1.html)">
  <input type="file" id="zipFile" accept=".zip">
  <button onclick="handleUpload()">🚀 Tải lên GitHub</button>
  <p id="status"></p>

  <!-- JSZip để giải nén -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
    const GITHUB_TOKEN = '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';
    const REPO_OWNER = 'khetcompany';
    const REPO_NAME = 'khet';

    async function handleUpload() {
      const fileInput = document.getElementById('zipFile');
      const filename = document.getElementById('filename').value.trim();
      const status = document.getElementById('status');
      if (!fileInput.files[0] || !filename) return alert("Vui lòng chọn file ZIP và nhập tên bài viết!");

      status.innerText = "⏳ Đang xử lý...";

      try {
        const zip = await JSZip.loadAsync(fileInput.files[0]);
        let htmlContent = "";
        const imageUploads = [];

        // Tìm file HTML đầu tiên
        for (const [path, file] of Object.entries(zip.files)) {
          if (path.endsWith(".html") && !file.dir) {
            htmlContent = await file.async("string");

            // Tìm tất cả src ảnh và thay thế đường dẫn
            htmlContent = htmlContent.replace(/<img\s+[^>]*src="([^"]+)"[^>]*>/g, (match, src) => {
              const filename = src.split('/').pop();
              return match.replace(src, `/media/img-post/${filename}`);
            });

            // Encode HTML to base64
            const htmlBase64 = btoa(unescape(encodeURIComponent(htmlContent)));
            await uploadToGitHub(`post/${filename}`, htmlBase64);
          }
        }

        // Upload ảnh
        for (const [path, file] of Object.entries(zip.files)) {
          if (!file.dir && /\.(jpg|jpeg|png|gif|webp)$/i.test(path)) {
            const imageData = await file.async("base64");
            const imageName = path.split('/').pop();
            await uploadToGitHub(`media/img-post/${imageName}`, imageData);
          }
        }

        status.innerText = "🎉 Đăng bài thành công!";
      } catch (err) {
        console.error(err);
        status.innerText = "❌ Lỗi: " + err.message;
      }
    }

    async function uploadToGitHub(path, contentBase64) {
      const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`, {
        method: "PUT",
        headers: {
          "Authorization": `token ${GITHUB_TOKEN}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: `Tự động upload ${path}`,
          content: contentBase64
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(`Upload thất bại (${path}): ${error.message}`);
      }
    }
  </script>
</body>
</html>
