<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ƒêƒÉng b√†i vi·∫øt - CMS Text2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <style>
    body {
      background-color: #1c2b38;
      color: #ccc;
      font-family: 'Segoe UI', sans-serif;
      padding: 40px;
    }
    h1 {
      font-size: 32px;
      color: #aaa;
      margin-bottom: 20px;
    }
    #title {
      background: transparent;
      border: none;
      font-size: 28px;
      color: #ccc;
      width: 100%;
      outline: none;
      margin-bottom: 20px;
    }
    .upload-box {
      background-color: #4b5b68;
      border: 2px dashed #999;
      padding: 40px;
      text-align: center;
      margin-bottom: 20px;
      color: #ccc;
      position: relative;
    }
    .upload-box input {
      position: absolute;
      width: 100%;
      height: 100%;
      opacity: 0;
      left: 0;
      top: 0;
      cursor: pointer;
    }
    #preview-img {
      max-height: 100px;
      margin-top: 10px;
      display: block;
    }
    #editor {
      background: #fff;
      color: #000;
      height: 300px;
      border-radius: 5px;
    }
    .toolbar {
      margin-bottom: 10px;
    }
    .actions {
      margin-top: 30px;
      display: flex;
      justify-content: space-between;
    }
    .btn {
      background: #2e88c4;
      color: white;
      padding: 10px 25px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    #wordCount {
      font-size: 14px;
      color: #888;
    }
  </style>
</head>
<body>

  <h1>Nh·∫≠p ti√™u ƒë·ªÅ b√†i vi·∫øt...</h1>
  
  <div style="margin-bottom: 20px; padding: 15px; background-color: #2a3f4f; border-radius: 5px;">
    <label for="githubToken" style="display: block; margin-bottom: 5px; color: #aaa;">GitHub Personal Access Token:</label>
    <input id="githubToken" type="password" placeholder="Nh·∫≠p GitHub token..." style="width: 100%; padding: 8px; background: #4b5b68; border: 1px solid #666; color: #ccc; border-radius: 3px;">
    <small style="color: #888; font-size: 12px;">Token c·∫ßn c√≥ quy·ªÅn repo ƒë·ªÉ upload file</small>
  </div>
  
  <input id="title" type="text" placeholder="Ti√™u ƒë·ªÅ b√†i vi·∫øt...">

  <div class="upload-box">
    <p>Th√™m ·∫£nh ƒë·∫°i di·ªán<br><small>Ho·∫∑c k√©o v√† th·∫£</small></p>
    <input type="file" id="thumbnailInput" accept="image/*">
    <img id="preview-img" />
  </div>

  <div class="toolbar">
    <div id="toolbar"></div>
  </div>
  <div id="editor"></div>

  <div class="actions">
    <span id="wordCount">B√†i vi·∫øt 0 ch·ªØ</span>
    <div>
      <button class="btn" onclick="previewPost()">Xem nh√°p</button>
      <button class="btn" onclick="saveDraft()">ƒê√£ l∆∞u</button>
      <button class="btn" onclick="submitPost()">ƒêƒÉng</button>
    </div>
  </div>

  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <script>
    const REPO_OWNER = 'khetcompany';
    const REPO_NAME = 'khet';
    const BRANCH = 'main';

    let uploadedThumbnailURL = '';

    const quill = new Quill('#editor', {
      modules: {
        toolbar: [
          [{ header: [1, 2, false] }],
          ['bold', 'italic', 'underline'],
          [{ list: 'ordered' }, { list: 'bullet' }],
          ['link', 'image']
        ]
      },
      theme: 'snow'
    });

    quill.on('text-change', function () {
      const text = quill.getText().trim();
      document.getElementById('wordCount').innerText = `B√†i vi·∫øt ${text.length} ch·ªØ`;
    });

    // Upload ·∫£nh ƒë·∫°i di·ªán
    document.getElementById("thumbnailInput").addEventListener("change", async function () {
      const file = this.files[0];
      const reader = new FileReader();
      reader.onloadend = async function () {
        const base64 = reader.result.split(',')[1];
        const path = `post/img-post/thumb-${Date.now()}-${file.name}`;

        const githubToken = document.getElementById('githubToken').value.trim();
        if (!githubToken) {
          alert("‚ùå Vui l√≤ng nh·∫≠p GitHub token!");
          return;
        }
        
        try {
          console.log('ƒêang upload ·∫£nh...');
          console.log('Image path:', path);
          
          const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`, {
            method: "PUT",
            headers: {
              Authorization: `token ${githubToken}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              message: `upload thumbnail ${file.name}`,
              content: base64,
              branch: BRANCH
            })
          });

          console.log('Image upload response status:', res.status);

          if (res.ok) {
            const data = await res.json();
            console.log('Image upload successful:', data);
            uploadedThumbnailURL = data.content.download_url;
            document.getElementById("preview-img").src = uploadedThumbnailURL;
          } else {
            const errorData = await res.json();
            console.error('Image upload failed:', errorData);
            alert(`‚ùå L·ªói upload ·∫£nh: ${errorData.message || 'Kh√¥ng x√°c ƒë·ªãnh'}`);
          }
        } catch (error) {
          console.error('Image upload network error:', error);
          alert(`‚ùå L·ªói k·∫øt n·ªëi khi upload ·∫£nh: ${error.message}`);
        }
      };
      reader.readAsDataURL(file);
    });

    function previewPost() {
      const newWin = window.open();
      const title = document.getElementById("title").value;
      const html = `
        <h1>${title}</h1>
        ${uploadedThumbnailURL ? `<img src="${uploadedThumbnailURL}" style="max-width: 100%"><br>` : ""}
        ${quill.root.innerHTML}
      `;
      newWin.document.write(html);
    }

    function saveDraft() {
      alert("Ch·ª©c nƒÉng l∆∞u nh√°p ch∆∞a ƒë∆∞·ª£c tri·ªÉn khai.");
    }

    async function submitPost() {
      const title = document.getElementById("title").value.trim();
      const content = quill.root.innerHTML;
      
      if (!title) {
        alert("‚ùå Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ b√†i vi·∫øt!");
        return;
      }
      
      if (!content || content.trim() === '<p><br></p>') {
        alert("‚ùå Vui l√≤ng nh·∫≠p n·ªôi dung b√†i vi·∫øt!");
        return;
      }
      
      const slug = title.toLowerCase().replace(/\s+/g, "-").replace(/[^\w\-]/g, "");
      const htmlContent = `
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${title}</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
    }
    img {
      max-width: 100%;
      height: auto;
      margin: 20px 0;
    }
    .content {
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <h1>${title}</h1>
  ${uploadedThumbnailURL ? `<img src="${uploadedThumbnailURL}" alt="${title}">` : ""}
  <div class="content">
    ${content}
  </div>
</body>
</html>`.trim();
      const base64 = btoa(unescape(encodeURIComponent(htmlContent)));

      const githubToken = document.getElementById('githubToken').value.trim();
      if (!githubToken) {
        alert("‚ùå Vui l√≤ng nh·∫≠p GitHub token!");
        return;
      }
      
                    try {
        console.log('ƒêang ƒëƒÉng b√†i...');
        console.log('Repository:', `${REPO_OWNER}/${REPO_NAME}`);
        console.log('File path:', `post/${slug}.html`);
        
        const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/post/${slug}.html`, {
          method: "PUT",
          headers: {
            Authorization: `token ${githubToken}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: `Post ${title}`,
            content: base64,
            branch: BRANCH
          })
        });

        console.log('Response status:', res.status);
        
        if (res.ok) {
          const result = await res.json();
          console.log('Upload successful:', result);
          alert("üéâ ƒêƒÉng b√†i th√†nh c√¥ng!");
          location.reload();
        } else {
          const errorData = await res.json();
          console.error('Upload failed:', errorData);
          alert(`‚ùå L·ªói khi ƒëƒÉng b√†i: ${errorData.message || 'Kh√¥ng x√°c ƒë·ªãnh'}`);
        }
      } catch (error) {
        console.error('Network error:', error);
        alert(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`);
      }
    }
  </script>
</body>
</html>
